<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>改造体重秤 by lly8877</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>改造体重秤</h1>
        <p>Weight Scale Hack</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/lly8877/WeightScaleHack" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/lly8877/WeightScaleHack/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/lly8877/WeightScaleHack/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h3>项目简介</h3>

<p>我做这个项目的是因为想把身边的普通体重秤变得更聪明一些，能够记录自动记录数据，并且绘制曲线。
这样我们就能够直观的看到自己体重变化的趋势，对自己的体重状况更加了解了。  </p>

<p>为了实现这个效果，基本思路是每一次用户称重的时候，体重秤就会自动把数据传到远程的服务器保存下来，然后用户可以通过电脑或者智能手机看到直观的体重变化曲线。
费这么大劲要把数据传到云端，是因为在本地记录数据不是很可靠，而且如何显示数据也是很大的问题。
所以这个把数据传到网上，用服务器进行数据的记录，分析和显示的方法应该是比较自然的方案。</p>

<p>具体来说就是用单片机读出体重，用无线芯片发到云端服务器，在服务器端进行记录和图标的绘制，用户访问网页登陆之后就能看到曲线了。目前的计划是用 <a href="http://www.arduino.cc/">Arduino</a> + <a href="http://electricimp.com/">Electric Imp</a> + <a href="http://rubyonrails.org/">Ruby on Rails</a> + <a href="http://www.heroku.com/">Heroku</a></p>

<hr><h3>数字体重计的原理</h3>

<p>第一步，想要记录体重，先要搞清现有的体重计原理。现在家里用的基本都是数字体重计，模拟的体重计可以先不考虑了。在网上搜了一下体重计的原理有很多，其中这个<a href="http://science.discovery.com/videos/deconstructed-digital-scale.html">视频</a>就讲的很简单明了。简单概括就是上边一定有一个压力传感器(load cell)，在我理解就是一形变，阻值就变的电阻，变化量基本和压力成线性关系。</p>

<p>然后买了一个在亚马逊上销量不错的<a href="http://www.amazon.com/EatSmart-Precision-Digital-Bathroom-Technology/dp/B001KXZ808/ref=sr_1_1?ie=UTF8&amp;qid=1347417794&amp;sr=8-1&amp;keywords=weight+scale">体重计</a>,先拆了研究一下里边的原理，看看到底和网上说的原理一样不一样。</p>

<p><img src="http://farm8.staticflickr.com/7140/7804074050_91a102dc7c.jpg" alt="拆开的体重秤"></p>

<p>果然结构和视频里拆的那个差不多，四个压力传感器，每个传感器红黑白三根线，都连接到电路板上。重量一增加，红和白之间的阻值就变小，白和黑之间的阻值就增大。</p>

<p>前排的两个传感器每一个里边有个触碰开关引出两根线，一定是用来唤醒芯片的。电路板后边是背光板和类似七段式的液晶屏。背光板是蓝色的，显示屏的液晶一改变朝向就遮挡住了蓝光，呈现黑色的数字。</p>

<p>下边是一些细节图</p>

<p>压力传感器特写</p>

<p><img src="http://farm8.staticflickr.com/7109/7804072890_f5fb4baf04.jpg" alt="压力传感器"></p>

<p>电路板特写</p>

<p><img src="http://farm9.staticflickr.com/8285/7804073740_d9b19ffbe3.jpg" alt="电路板特写"></p>

<p>到这里数字体重计的几个模块已经很明白了，电路板上的芯片直接读传感器的电压，然后经过内部的分析处理，然后通过驱动液晶屏的13个管脚，显示数字。</p>

<p>这是电路板背面，液晶屏和背光板</p>

<p><img src="http://farm9.staticflickr.com/8454/7978417825_ccfcd62fef.jpg" alt="电路板背面，液晶屏和背光板"></p>

<p>电路板和液晶屏是用这样一个海绵状的排线连接的</p>

<p><img src="http://farm9.staticflickr.com/8283/7804071848_3946c2d87f.jpg" alt="海绵状的排线"></p>

<hr><h3>Arduino读取体重的方法</h3>

<p>目前我觉得想要用单片机读到体重示数，有两个办法。一是通过读液晶屏驱动管脚的电压来得到最终体重。二是直接读传感器的阻值，自己来算体重。第一个方案直接读液晶屏看起来简单一些，所以我们先走一号路线。</p>

<hr><h3>从液晶屏管脚读示数</h3>

<p>先用示波器看看这13个管脚在我们称重的时候都是什么波形呢？</p>

<p>测了两个管脚，大概是这样的波形</p>

<p><img src="http://farm9.staticflickr.com/8041/7978415718_88ec08e17c.jpg" alt="液晶屏管脚波形">
这个结果和我最初想象的不一样，我以为这种液晶屏和七段式的LED数码管原理差不多，只是有一条线选择数字，另外七根线来用高低控制液晶，没想到竟然还有阶梯状的电压。只好找一找液晶屏的原理了。这里找到一个液晶控制芯片的<a href="http://www.atmel.com/Images/doc2530.pdf">datasheet</a>很有帮助，里边讲了这种液晶屏的工作原理。</p>

<p>datasheet里边讲的很清楚了，这样图尤其说明问题</p>

<p><img src="http://farm9.staticflickr.com/8301/7978727497_a55ef35392.jpg" alt="datasheet中其中一张插图"></p>

<p>目前我的理解是液晶屏如果要改变透光性，每一个模子里的液晶两极需要加电压。这种简单的液晶屏由于不需要亮度调节只要每一片液晶用两根线就能驱动了。屏幕里边的走线分行列两种，每个行列的交叉点就是一块液晶，上边的电压就是当前行列两根线的电压差。这里我说的行列对应了图中的COM和SEG。可以看到左右两个图分别是两个同列(都是SEG0)不同行的(COM0 和 COM1)液晶，加在左边的电压有时候能达到V_LCD，也就是一个能改变液晶性质的阈值电压。右边的达不到这个阈值，因此应该一直是透光的。这里还有一个小细节是液晶一般都需要直流分量是零的电压，因为长期的直流分量会损害液晶。
回到我们要读数的这块液晶上，观察发现每个管脚的电压都是在0-3.3V之间变化的。当COM是3.3V，SEG是0V或者COM是0V，SEG是3.3V的时候这个液晶上的电压的绝对值就能到3.3V，相当于被选中。我们只要捕捉到这个瞬间就可以了。于是我们来搭一个简单的<a href="https://github.com/lly8877/WeightScaleHack/tree/master/EagleFiles/LCDToArduino">电路</a></p>

<p><img src="http://farm9.staticflickr.com/8450/7978781987_3d2d7487f5.jpg" alt="读LCD的电路"></p>

<p>然后照着这个焊了个板子</p>

<p><img src="http://farm9.staticflickr.com/8308/7978415439_d396b43fe0.jpg" alt="焊的电路板"></p>

<p>然后把液晶的管脚都接出来连到Arduino上。</p>

<p><img src="http://farm9.staticflickr.com/8029/7978417492_c8e2aa9e44.jpg" alt="最终读数据的图"></p>

<h3>Arduino程序</h3>

<p>于是我们已经能让Arduino知道液晶屏的每一个像素点是否被选中了。不过具体这些像素到底对应的是实际数字的哪一笔我们还是不知道。这让人心里十分没底。刚才的分析是否正确呢？要破解这个疑问，找出行列组合和实际笔画的对应关系，我们有两个事实我们可以借助。第一个是秤空载的时候，示数是0.0。第二个是如果仔细看液晶屏，其实还是能看到一些里边的走线的。最终配合Arduino读数的输出，能够大概猜出液晶屏上每一个像素的行和列的序号。</p>

<p><img src="http://farm9.staticflickr.com/8444/7978417956_b33377da93.jpg" alt="像素对应关系"></p>

<p>写了一个简单的<a href="https://github.com/lly8877/WeightScaleHack/blob/master/ArduinoCode/LCDToArduino/LCDToArduino.ino">Arduino程序</a>
输出如下：</p>

<blockquote>
<p>-----0---------<br>
0011100000<br>
1111100000<br>
0101000000<br>
0111100000<br>
weight: 0.0<br>
-----1---------<br>
0011100000<br>
1111100000<br>
0101000000<br>
0111100000<br>
weight: 0.0<br>
.<br>
.<br>
.<br>
-----29---------<br>
0011100000<br>
1101110000<br>
0110110000<br>
0101110000<br>
weight: 76.3<br>
-----30---------<br>
0011100000<br>
1101110000<br>
0110110000<br>
0101110000<br>
weight: 76.3    </p>
</blockquote>

<p>到此为止，我们已经精确地读出液晶显示屏的示数了。在我们把它用Electric Imp传到网上前，我们还是也评估一下另一个方案的优略，也就是直接读压力传感器的示数。</p>

<hr><h3>直接读压力传感器示数</h3>

<p>通过读液晶屏输出很不错，节省了读模拟电压，数据处理的烦恼。不过要焊的线真的很多，而且想再复制一个的话，必须要用一个完全一样的液晶屏的秤。因此我觉得还是有必要采用直接读实数的方法。</p>

<p>未完待续</p>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/lly8877">lly8877</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>